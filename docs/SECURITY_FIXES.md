# üîí –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## –î–∞—Ç–∞: 2024

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏

### ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 1. Callback Data Injection - –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª—ã:** `handlers/codes.py`, `handlers/permissions.py`, `handlers/registration.py`, `handlers/start.py`

**–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `validate_callback_data()` –≤ `utils/security.py`
- –í—Å–µ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞ –∏ –≥—Ä–∞–Ω–∏—Ü—ã –∑–Ω–∞—á–µ–Ω–∏–π

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `callback_get_code()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è owner_id
- `process_approve()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è requester_id
- `process_deny()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è requester_id
- `callback_request_access()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è owner_id
- `process_platform_choice()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `process_unregister_confirm()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è user_id
- `callback_help_section()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞ —Å–ø—Ä–∞–≤–∫–∏

---

#### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ callback - –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª—ã:** `handlers/codes.py`, `handlers/permissions.py`

**–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `db.check_permission()` –≤ `callback_get_code()` –ø–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –∫–æ–¥–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è pending –∑–∞–ø—Ä–æ—Å–∞ –≤ `process_approve()` –∏ `process_deny()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –í callback_get_code —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å:
has_permission = db.check_permission(owner_id, requester_id)
if not has_permission:
    await callback.answer("üîí –£ —Ç–µ–±—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞!", show_alert=True)
    return
```

---

#### 3. Rate Limiting - –î–û–ë–ê–í–õ–ï–ù–û
**–§–∞–π–ª—ã:** `utils/security.py`, –≤—Å–µ handlers

**–ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `utils/security.py` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `check_rate_limit()`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏–º–∏—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
  - `get_code`: 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
  - `register`: 3 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ 5 –º–∏–Ω—É—Ç
  - `request_access`: 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
  - `check_email`: 3 –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –º–∏–Ω—É—Ç—É
  - `my_code`: 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è—é—Ç rate limit –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–µ–º –¥–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

---

### ‚úÖ –°—Ä–µ–¥–Ω–∏–µ (—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è email - –£–õ–£–ß–®–ï–ù–û
**–§–∞–π–ª—ã:** `utils/security.py`, `handlers/permissions.py`, `handlers/registration.py`

**–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `validate_email()` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã, —Ñ–æ—Ä–º–∞—Ç–∞, –¥–æ–º–µ–Ω–∞
- –ó–∞–º–µ–Ω–µ–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è `is_email()` –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- Email —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î

---

#### 5. –£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –æ—à–∏–±–∫–∞—Ö - –ò–°–ü–†–ê–í–õ–ï–ù–û
**–§–∞–π–ª—ã:** `utils/security.py`, –≤—Å–µ handlers

**–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `sanitize_error_message()` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –£–¥–∞–ª–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `handlers/codes.py` - –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- `handlers/registration.py` - –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- `handlers/permissions.py` - –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

---

#### 6. Timeout –¥–ª—è IMAP - –î–û–ë–ê–í–õ–ï–ù–û
**–§–∞–π–ª—ã:** `utils/email_parser.py`

**–ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω timeout 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤—Å–µ—Ö IMAP –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å—à–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ DoS —á–µ—Ä–µ–∑ –¥–æ–ª–≥–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
IMAP_TIMEOUT = 30
socket.setdefaulttimeout(IMAP_TIMEOUT)
self.connection = imaplib.IMAP4_SSL(server, port, timeout=IMAP_TIMEOUT)
```

---

## –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

- `utils/security.py` - –º–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π, rate limiting –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–µ–π –æ—à–∏–±–æ–∫

## –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `handlers/codes.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `handlers/permissions.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `handlers/registration.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `handlers/start.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è help callback
- `utils/email_parser.py` - –¥–æ–±–∞–≤–ª–µ–Ω timeout –¥–ª—è IMAP

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è

1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `structlog`)
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
3. **–ê—É–¥–∏—Ç** - —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
4. **–ö–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è** - —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ per-user keys –∏–ª–∏ –≤–Ω–µ—à–Ω–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å rate limiting –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è email —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—à–∏–±–∫–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
